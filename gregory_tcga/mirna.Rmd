---
output:
  html_document:
    toc: true
    highlight: zenburn
---
```{r knitr,eval=F,echo=F}
source("~/repos/myRfunctions/transactions.R")
dn <- "gregory_mirna"
library(rmarkdown)
library(knitrBootstrap)
library(knitr)
knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png", fig.width=9,fig.heigh=9, echo=FALSE,
               cache=FALSE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE,
               message=FALSE, prompt=TRUE, comment='', fig.cap='', bootstrap.show.code=FALSE)
# render_2_drop("~/repos/pipelines/gregory_tcga/mirna.Rmd",dn)
render("~/repos/pipelines/gregory_tcga/mirna.Rmd")
```

```{r libraries}
library(rmarkdown)
library(knitrBootstrap)
library(knitr)
library(ggplot2)
library(pheatmap)
library(limma)
library("dplyr")
library("tidyr")
library("magrittr")
```

```{r db}
mirdb = read.table("~/repos/pcbc_c4_analysis/data/targets/hsa_miRDB_v5.0_prediction_result.txt")
mirs = c("hsa-mir-92a-1","hsa-mir-92a-2","hsa-mir-92b","hsa-mir-17",
         "hsa-mir-18a","hsa-mir-18b","hsa-mir-20a","hsa-mir-20b","hsa-mir-19a")
mirdb$precursor = gsub("-[35]p","",mirdb$V1)
mirdb_red = mirdb[mirdb$precursor %in% gsub("mir","miR",mirs), ]
library(org.Hs.eg.db)
library(AnnotationDbi)
symbol = AnnotationDbi::select(org.Hs.eg.db, unique(as.character(unlist(mirdb_red[,2]))), "ENTREZID", keytype="REFSEQ")
idx = match(mirdb_red$V2,symbol$REFSEQ)
mirdb_red$entrezid = symbol[idx,2]
```

```{r cor-function}
cor_w_ratio = function(v,mir){
    f = cor.test(v,mir)
    c(f$p.value,f$estimate)
}

find_protein = function(mirs, mrna, mirna, mirdb_red){
    common = intersect(colnames(mrna), rownames(dd))
    res = data.frame()
    for (mir in mirs){
        cor_mrna = t(apply(mrna[,common],1,cor_w_ratio,mirna[common,mir]-mirna[common,"hsa.mir.92a.1"]))
        cor_mrna = as.data.frame(cor_mrna)
        cor_mrna$fdr = p.adjust(cor_mrna$V1)
        # create useful columns and filter significants
        sign = cor_mrna %>% mutate(ratio=paste0(mir,"_vs_hsa.mir.92a.1"),gene=rownames(mrna), mir=mir)  %>%
            dplyr::select(mir,ratio,gene,pvalue=V1,cor,fdr) %>%
            separate(gene, into=c("symbol", "entrezid"), sep="\\|", extra="drop") %>%
            filter(fdr < 0.1, abs(cor)>0.7)
        
        if (nrow(sign)>0){
            targets = mirdb_red %>% 
                filter(precursor==c(gsub("[::.::]","-",gsub("mir","miR",mir)),"hsa-miR-92a-1")) %>% 
                filter(entrezid %in% sign$entrezid)
            idx = match(targets$entrezid, sign$entrezid)
            sign[idx,"is_target"] = "YES"
            res = rbind(sign, res)
        }
    }
    res
}
```

# LUSC

## Processing all data

Andreas extracted the data to get all mRNA and miRNA expression values.

I will use miR-92a-1 since is the precursor shared with the other miRNAs.

```{r load-lusc}
clean_id = function(x){
    id = unlist(strsplit(x, "-" ))
    paste0(id[1], id[2], id[3], id[4])
}
clean_id_cols = function(x){
    id = unlist(strsplit(x, "[::.::]" ))
    paste0(id[1], id[2], id[3], id[4])
}

ggplot <- function(...) ggplot2::ggplot(...) + scale_color_brewer(palette="Set1") + theme_bw()

mat = read.table("~/orch/scratch/gregory_pca/extracted_data/mir-lusc.counts.txt", header=T, check.names = F, row.names=1)
colnames(mat) = sapply(colnames(mat),clean_id_cols)

meta = read.table("~/orch/scratch/gregory_pca/extracted_data/mir-lusc.metadata.txt", header=T, check.names = F, row.names=1)
rownames(meta) = sapply(row.names(meta),clean_id)

mrna = read.table("~/orch/scratch/gregory_pca/extracted_data/mrna-lusc.norm.txt", header=T, check.names = F, row.names=1)
colnames(mrna) = sapply(colnames(mrna),clean_id_cols)

isy1 = grepl("ISY1", rownames(mrna))

voom_m = voom(mat, model.matrix(~ 0 + meta$status ) )

sub=voom_m$E[mirs,]
#colnames(sub) = rownames(meta)
pheatmap(sub, clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta, show_rownames = T, show_colnames = F)
```

### correlation of mirnas

```{r cluas-cor}
dd = data.frame(t(sub[mirs,]))
dd$class = meta[rownames(dd),"status"]

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.17,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.18a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.19a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.20a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")
```

### miRNA ratio in tumor/healthy

```{r lusc-ratio}
ratio_mat = data.frame(ratio = dd$hsa.mir.17-dd$hsa.mir.92a.1,
                       class = dd$class )
ggplot(ratio_mat) + 
    geom_boxplot(aes(x=class, y=ratio)) +
    geom_jitter(aes(x=class, y=ratio)) +
    ggtitle("log2FC of mir17/mir92")

ggplot(dd,aes(x=class, y=hsa.mir.18a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir18/mir92")

ggplot(dd,aes(x=class, y=hsa.mir.20a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir20/mir92")

ggplot(dd,aes(x=class, y=hsa.mir.19a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir19/mir92")
```

### ISY1 expression

```{r isy1-exp}
common = intersect(colnames(mrna), rownames(meta))

exp = data.frame(isy1=unlist(mrna[isy1,common]),class=meta[common,"status"])
ggplot(exp,aes(x=class, y=isy1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("isy1")

```


### mir-18/mir-92 ratio vs ISY1, log2

```{r lusc-cor-mir18-log2}
common = intersect(colnames(mrna), rownames(dd))

dd[common, "isy1"] = unlist(mrna[isy1,common])

ggplot(dd) +
    geom_point(aes(x=hsa.mir.18a-hsa.mir.92a.1,y=log2(isy1))) +
    facet_wrap(~class, nrow=2)


r = dd$hsa.mir.18a - dd$hsa.mir.92a.1
cor.test(r, log2(dd$isy1))

ggplot(dd) +
    geom_point(aes(x=hsa.mir.17-hsa.mir.92a.1,y=log2(isy1))) +
    facet_wrap(~class, nrow=2)

r = dd$hsa.mir.17 - dd$hsa.mir.92a.1
cor.test(r, log2(dd$isy1))

```

### mir-18/mir-92 ratio vs ISY1, no-transformation

```{r lusc-cor-mir18}

ggplot(dd) +
    geom_point(aes(y=2^(hsa.mir.18a)/2^(hsa.mir.92a.1),x=isy1)) +
    facet_wrap(~class, nrow=2)

r = 2^(dd$hsa.mir.18a)/2^(dd$hsa.mir.92a.1)
cor.test(r, dd$isy1)
```

## LUSC data from basecamp file

only tumors

### correlation of miRNAs

```{r lusc-isy}
lusc_mrna = read.table("~/repos/pipelines/gregory_tcga/isy1_17-92.txt", header=T, row.names=1,sep="\t")

ggplot(lusc_mrna, aes(y=log2(miR.92a.1), x=log2(miR.17))) +
    geom_point() +
    geom_smooth()

ggplot(lusc_mrna, aes(y=log2(miR.92a.1), x=log2(miR.18))) +
    geom_point() +
    geom_smooth()

ggplot(lusc_mrna, aes(y=log2(miR.92a.1), x=log2(miR.19a))) +
    geom_point() +
    geom_smooth()

ggplot(lusc_mrna, aes(y=log2(miR.92a.1), x=log2(miR.20a))) +
    geom_point() +
    geom_smooth()
```

### miRNA ratio vs ISY1

```{r lusc-with-protein}
ggplot(lusc_mrna) +
    geom_point(aes(y=miR.17/miR.92a.1,x=(isy1),colour="92.a-isy1")) +
    stat_smooth(aes(y=miR.17/miR.92a.1,x=(isy1),colour="92.a-isy1"), method='lm')

ggplot(lusc_mrna) +
    geom_point(aes(y=miR.18/miR.92a.1,x=(isy1),colour="92.a-isy1")) +
    stat_smooth(aes(y=miR.18/miR.92a.1,x=(isy1),colour="92.a-isy1"), method='lm')

r = 2^(lusc_mrna$miR.18)/2^(lusc_mrna$miR.92a.1)
cor.test(r, lusc_mrna$isy1)

```

## missing samples in raw data

```{r missing}
sum(is.na(meta[sapply(row.names(lusc_mrna), clean_id),1]))
setdiff(sapply(row.names(lusc_mrna), clean_id),rownames(meta))
```

```{r check,echo=F,eval=F}
samples = gsub("[::.::]","-",colnames(mat))
plot(mrna[samples,"miR.92a.2"],mat["hsa-mir-92a-2",])
```

## protein correlation with ratio

```{r lusc-table-proteins, results='asis'}
res_lusc = find_protein(c("hsa.mir.17","hsa.mir.18a","hsa.mir.20a","hsa.mir.19a"),mrna,dd,mirdb_red)
res_lusc
```

# COAD

## Processing all data

```{r load-coad}
mat = read.table("~/orch/scratch/gregory_pca/extracted_data/mir-hg18-coad.counts.txt", header=T, check.names = F, row.names=1)
#uniques = as.character((data.frame(name=colnames(mat), clean=sapply(colnames(mat),clean_id_cols) ) %>% distinct(clean))[,1])
#mat = mat[, uniques]
colnames(mat) = sapply(colnames(mat),clean_id)

meta = read.table("~/orch/scratch/gregory_pca/extracted_data/mir-hg18-coad.metadata.txt", header=T, check.names = F, row.names=1)
#meta = meta[gsub("[::.::]", "-", uniques),]
rownames(meta) = sapply(row.names(meta),clean_id)

mrna = read.table("~/orch/scratch/gregory_pca/extracted_data/mrna-coad.norm.txt", header=T, check.names = F, row.names=1)
colnames(mrna) = sapply(colnames(mrna),clean_id_cols)

isy1 = grepl("ISY1", rownames(mrna))

voom_m = voom(mat, model.matrix(~ 0 + meta$status ) )

mirs = c("hsa-mir-92a-1","hsa-mir-92a-2","hsa-mir-92b","hsa-mir-17",
         "hsa-mir-18a","hsa-mir-18b","hsa-mir-20a","hsa-mir-20b","hsa-mir-19a")
sub=voom_m$E[mirs,]
colnames(sub) = rownames(meta)
pheatmap(sub, clustering_distance_rows = "correlation", clustering_distance_cols = "correlation", clustering_method = "ward", annotation = meta, show_rownames = T, show_colnames = F)
```

### correlation of mirnas

```{r coad-cor}
dd = data.frame(t(sub[mirs,]))
dd$class = meta[rownames(dd),"status"]

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.17,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.18a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.19a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")

ggplot(dd,aes(x=hsa.mir.92a.1,y=hsa.mir.20a,colour=class)) +
    geom_point()+
    stat_smooth(method="lm")
```

### miRNA ratio in tumor/healthy

```{r coad-ratio}
ratio_mat = data.frame(ratio = dd$hsa.mir.17-dd$hsa.mir.92a.1,
                       class = dd$class )
ggplot(ratio_mat) + 
    geom_boxplot(aes(x=class, y=ratio)) +
    geom_jitter(aes(x=class, y=ratio)) +
    ggtitle("log2FC of mir17/mir92")

ggplot(dd,aes(x=class, y=hsa.mir.18a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir18/mir92")

ggplot(dd,aes(x=class, y=hsa.mir.20a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir20/mir92")


ggplot(dd,aes(x=class, y=hsa.mir.19a-hsa.mir.92a.1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("log2FC of mir19/mir92")

```

### ISY1 expression

```{r coad-isy1-exp}
common = intersect(colnames(mrna), rownames(meta))

exp = data.frame(isy1=unlist(mrna[isy1,common]),class=meta[common,"status"])
ggplot(exp,aes(x=class, y=isy1)) + 
    geom_boxplot() +
    geom_jitter() +
    ggtitle("isy1")

```

### mir-17/mir-92 ratio vs ISY1, log2

```{r coad-cor-mir17-log2}
common = intersect(colnames(mrna), rownames(dd))

dd[common, "isy1"] = unlist(mrna[isy1,common])

ggplot(dd) +
    geom_point(aes(x=hsa.mir.17-hsa.mir.92a.1,y=log2(isy1),colour="18-isy1")) +
    facet_wrap(~class, nrow=2)

r = dd$hsa.mir.17 - dd$hsa.mir.92a.1

cor.test(r, log2(dd$isy1))
```

### mir-17/mir-92 ratio vs ISY1, no-transformation

```{r coad-cor-mir17}
common = intersect(colnames(mrna), rownames(dd))

dd[common, "isy1"] = unlist(mrna[isy1,common])

ggplot(dd) +
    geom_point(aes(y=exp(hsa.mir.17)/exp(hsa.mir.92a.1),x=isy1,colour="18-isy1")) +
    facet_wrap(~class, nrow=2)

r = exp(dd$hsa.mir.17)/exp(dd$hsa.mir.92a.1)

cor.test(r, dd$isy1)
```

## COAD data from basecamp file

only tumors

### correlation of miRNAs

```{r coad-isy}
coad_mrna = read.table("~/repos/pipelines/gregory_tcga/COAD.ISY.txt.with.miR17-92_patient.txt.txt", header=T, row.names=1,sep="\t")

ggplot(coad_mrna, aes(y=log2(mIR92a.1), x=log2(miR17))) +
    geom_point() +
    geom_smooth()

ggplot(coad_mrna, aes(y=log2(mIR92a.1), x=log2(miR18a))) +
    geom_point() +
    geom_smooth()

ggplot(coad_mrna, aes(y=log2(mIR92a.1), x=log2(miR19a))) +
    geom_point() +
    geom_smooth()

ggplot(coad_mrna, aes(y=log2(mIR92a.1), x=log2(miR20a))) +
    geom_point() +
    geom_smooth()
```

### miRNA ratio vs ISY1

```{r coad-with-protein}
ggplot(coad_mrna) +
    geom_point(aes(y=miR17/mIR92a.1,x=(X),colour="92.a-isy1")) +
    geom_smooth(aes(y=miR17/mIR92a.1,x=(X),colour="92.a-isy1"))

ggplot(coad_mrna) +
    geom_point(aes(y=miR18a/mIR92a.1,x=(X),colour="92.a-isy1")) +
    geom_smooth(aes(y=miR18a/mIR92a.1,x=(X),colour="92.a-isy1"))
```

## protein correlation with ratio

```{r coad-table-proteins, results='asis'}
res_coad = find_protein(c("hsa.mir.17","hsa.mir.18a","hsa.mir.20a","hsa.mir.19a"),mrna,dd,mirdb_red)
kable(res_coad, digits = 4)
```

