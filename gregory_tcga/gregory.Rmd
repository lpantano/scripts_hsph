---
output:
  knitrBootstrap::bootstrap_document:
    title: "Gregory - miRNA TCGA PCA"
    theme: readable
    highlight: zenburn
    theme.chooser: FALSE
    highlight.chooser: FALSE


---

```{r projsetup, echo=FALSE, warning=FALSE, message=FALSE}
project="Gregory - miRNA TCGA PCA"
clientname="Peng Du"
clientemail=""
labPI="RichardGregory"
lablocation="Children's"
analystname="Andreas Sjodin"
analystemail="sjodin@hsph.harvard.edu"

```


```{r knitrsetup, echo=FALSE}
knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png", bootstrap.show.code=FALSE, bootstrap.show.output=FALSE, bootstrap.thumbnail.size="col-md-10", cache=TRUE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE, message=FALSE, prompt=TRUE, comment='', fig.cap='', tidy.opts=list(keep.blank.line=FALSE, width.cutoff=200), fig.width = 16, fig.height = 14)

```


---

# Gregory - miRNA TCGA PCA

miRNA TCGA PCA analysis for  `r clientname`, `r labPI` group at `r lablocation`.  

Contact `r analystname` (`r analystemail`) for additional details.

The most recent update of this html document occurred: `r date()`

The sections below provide code to reproduce the included results and plots. 

---

```{r libaries}
library(readr)
library(pcaMethods)
library(ggplot2)
library(gridExtra)
```


## Functions

```{r functions}
concat.miRNA <- function(filedir, files, rstring=".mirna.quantification.txt"){
  rpm <- vector()
  tmp <- read_tsv(file.path(filedir, files[1]))
  row.names(tmp) = tmp$miRNA_ID
  counts <- data.frame(tmp$read_count, row.names=tmp$miRNA_ID)
  for (file in files[2:length(files)]){
    tmp <- read_tsv(file.path(filedir, file))
    row.names(tmp) = tmp$miRNA_ID
    idx = intersect(row.names(counts), tmp$miRNA_ID)
    counts = cbind(counts[idx,], tmp[idx,"read_count"])
    row.names(counts) = idx
    #rpm<-cbind(rpm, tmp["reads_per_million_miRNA_mapped"][,1])  
    #print(nrow(tmp) )
    
  }
    #rownames(counts) <- tmp$miRNA_ID
    #rownames(rpm) <- tmp$miRNA_ID

    ids <- gsub(rstring, "", files)
    colnames(counts) <- ids
    #colnames(rpm) <- ids
    return(list(counts=counts, rpm=rpm))
}

concat.easy.miRNA <- function(filedir, files, rstring=".mirna.quantification.txt" ){
    counts <- vector()
    ids <- vector()
    for (file in files){
        tmp <- read_tsv(file.path(filedir, file))
        counts<-cbind(counts, tmp$read_count)
        ids <- c(ids, gsub(rstring, "", file))
        
    }
    rownames(counts) <- tmp$miRNA_ID
    # ids <- gsub(rstring, "", files)
    colnames(counts) <- ids
    return(counts)
}

concat.mRNA <- function(filedir, files, fileconv, column){
  counts <- vector()
  for (file in files){
    tmp <- read_tsv(file.path(filedir, file))
    counts<-cbind(counts, tmp[column][,1])
    #print(nrow(tmp) )
    
  }
rownames(counts) <- tmp$gene_id
idx <- match(files, fileconv[,1])


ids <- as.character(fileconv[idx,2])
colnames(counts) <- ids

return(counts)
}

plot.pca <- function (pcadata, condition= NULL, type="score", xi=1, yi=2, text=TRUE, title=""){
    require(pcaMethods)
  k = dim( pcadata)[3]
    xnames = paste0("PC", 1:k, " ", round(pcadata@R2 * 100,  digits = 1), "%")
  if (type == "loadings"){
     df <- loadings(pcadata)
	} else {
	   df <- scores(pcadata)
	}
    df = as.data.frame(df[, c(xi, yi)])
    names(df) = c("one", "two")
	df$label = rownames(df)
	if (text){
	    if (!is.null(condition)) {
	        df$condition = condition
	        p = ggplot(df, aes(one, two, label = label, color = condition)) + 
	            geom_text(aes(one, two, label = label), size = 3) + 
	            labs(list(x = xnames[xi], y = xnames[yi])) + 
				      scale_x_continuous() +
            ggtitle(title) +
            theme(plot.title = element_text(size=20, face="bold", vjust=2)) 

	    }
	    else {
	        p = ggplot(df, aes(one, two)) + 
			    geom_text(aes(one, two, label = label), size = 3) + 
				labs(list(x = xnames[xi], y = xnames[yi])) + 
				scale_x_continuous() +
            ggtitle(title) +
            theme(plot.title = element_text(size=20, face="bold", vjust=2))           
	    }
	} else {
	    if (!is.null(condition)) {
	        df$condition = condition
	        p = ggplot(df, aes(one, two, label = label, color = condition)) + 
	            geom_point(aes(one, two, label = label), size = 4) + 
	            labs(list(x = xnames[xi], y = xnames[yi])) + 
            ggtitle(title) +
            theme(plot.title = element_text(size=20, face="bold", vjust=2)) +            
				scale_x_continuous()
	    }
	    else {
	        p = ggplot(df, aes(one, two)) + 
			    geom_point(aes(one, two, label = label), size = 4) + 
				labs(list(x = xnames[xi], y = xnames[yi])) + 
            ggtitle(title) +
            theme(plot.title = element_text(size=20, face="bold", vjust=2)) +              
				scale_x_continuous()
	    }	
	}
    return(p)
}

```

## Loading data

Set up data directory paths

```{r datadirs}
# COAD 
coad.healthy.dir <- "~/orch/scratch/gregory_pca/rawdata/COAD/miRNA/health/miRNASeq/BCGSC__IlluminaHiSeq_miRNASeq/Level_3/"
coad.tumor.dir <-"~/orch/scratch/gregory_pca/rawdata/COAD/miRNA/tumor/input/"
# coad.tumor2.dir <-"~/orch/scratch/gregory_pca/patient/COAD/miRNA/tumor/034ad892-e95c-43c1-90d5-5cba9fac242b/miRNASeq/BCGSC__IlluminaGA_miRNASeq/Level_3/"

mrna.coad.healthy.dir <- "/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/COAD/RNA-seq/health/a69ac69d-a292-4021-9bd3-074ea563272c/RNASeqV2/UNC__IlluminaHiSeq_RNASeqV2/Level_3/" 
mrna.coad.tumor.dir <-"/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/COAD/RNA-seq/tumor/a036583c-92ac-4f8d-92cc-268452e0084f/RNASeqV2/UNC__IlluminaHiSeq_RNASeqV2/Level_3/"


# LUSC
lusc.healthy.dir <- "/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/miRNA/health/953f718e-a2f5-48f9-9292-a0a9c02f347d/miRNASeq/BCGSC__IlluminaHiSeq_miRNASeq/Level_3/"
lusc.tumor.dir <-"/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/miRNA/tumor/9c22ddce-e628-4c3e-8116-ec58f155c62b/miRNASeq/BCGSC__IlluminaHiSeq_miRNASeq/Level_3/"

lusc.all.dir <- "~/orch/scratch/gregory_pca/rawdata/LUSC/miRNA/illumina_hiseq/input/"

mrna.lusc.healthy.dir <- "/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/RNA-seq/health/576b67c4-157f-429d-8727-86534a9c0935/RNASeqV2/UNC__IlluminaHiSeq_RNASeqV2/Level_3/" 
mrna.lusc.tumor.dir <-"/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/RNA-seq/tumor/14617e7e-4f91-4ba5-a2bd-a0d76b3ad009/RNASeqV2/UNC__IlluminaHiSeq_RNASeqV2/Level_3/"


# Fig data
fig.dir <- "/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/figdata"

```

Exctract files of interest

```{r}
#miRNA
coad.healthy.files <- grep("3.mirna.quantification.txt", dir(coad.healthy.dir), value=T)
coad.tumor.files <- grep("3.mirna.quantification.txt", dir(coad.tumor.dir), value=T) #Different number of rows!
#coad.tumor2.files <- grep("mirna.quantification.txt", dir(coad.tumor2.dir), value=T)

coad.healthy.hg19.files <- grep("hg19.mirna.quantification.txt", dir(coad.healthy.dir), value=T)
coad.tumor.hg19.files <- grep("hg19.mirna.quantification.txt", dir(coad.tumor.dir), value=T)
coad.tumor2.hg19.files <- grep("hg19.mirna.quantification.txt", dir(coad.tumor2.dir), value=T)

lusc.healthy.files <- grep("mirna.quantification.txt", dir(lusc.healthy.dir), value=T)
lusc.tumor.files <- grep("mirna.quantification.txt", dir(lusc.tumor.dir), value=T)

lusc.all.files <- grep("mirna.quantification.txt", dir(lusc.all.dir), value=T)

#mRNA
mrna.coad.healthy.files.raw <- grep("rsem.genes.results", dir(mrna.coad.healthy.dir), value=T)
mrna.coad.tumor.files.raw <- grep("rsem.genes.results", dir(mrna.coad.tumor.dir), value=T) 
#Skipping GA
mrna.coad.healthy.files.norm <- grep("rsem.genes.normalized_results", dir(mrna.coad.healthy.dir), value=T)
mrna.coad.tumor.files.norm <- grep("rsem.genes.normalized_results", dir(mrna.coad.tumor.dir), value=T) 

mrna.lusc.healthy.files.raw <- grep("rsem.genes.results", dir(mrna.lusc.healthy.dir), value=T)
mrna.lusc.tumor.files.raw <- grep("rsem.genes.results", dir(mrna.lusc.tumor.dir), value=T)
mrna.lusc.healthy.files.norm <- grep("rsem.genes.normalized_results", dir(mrna.lusc.healthy.dir), value=T)
mrna.lusc.tumor.files.norm <- grep("rsem.genes.normalized_results", dir(mrna.lusc.tumor.dir), value=T) 
```

Load data and concatenate


```{r convfiles}
#Conversion files
coad.healthy.nameconv <- read.table("/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/COAD/RNA-seq/health/a69ac69d-a292-4021-9bd3-074ea563272c/FILE_SAMPLE_MAP.txt")
coad.tumor.nameconv <- read.table("/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/COAD/RNA-seq/tumor/a036583c-92ac-4f8d-92cc-268452e0084f/FILE_SAMPLE_MAP.txt")

lusc.healthy.nameconv <- read.table("/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/RNA-seq/health/576b67c4-157f-429d-8727-86534a9c0935/FILE_SAMPLE_MAP.txt")
lusc.tumor.nameconv <- read.table("/Users/andreassjodin/hbc-projects/orchestra/gregory_pca/patient/LUSC/RNA-seq/tumor/14617e7e-4f91-4ba5-a2bd-a0d76b3ad009/FILE_SAMPLE_MAP.txt")

```


```{r concatenate-data}
#miRNA
coad.healthy <- concat.miRNA(coad.healthy.dir, coad.healthy.files,rstring=".mirna.quantification.txt")
coad.tumor <- concat.miRNA(coad.tumor.dir, coad.tumor.files,rstring=".mirna.quantification.txt")
#coad.tumor2 <- concat.miRNA(coad.tumor2.dir, coad.tumor2.files,rstring=".mirna.quantification.txt")

coad.healthy.hg19 <- concat.miRNA (coad.healthy.dir, coad.healthy.hg19.files)
coad.tumor.hg19 <- concat.miRNA (coad.tumor.dir, coad.tumor.hg19.files)
coad.tumor2.hg19 <- concat.miRNA (coad.tumor2.dir, coad.tumor2.hg19.files)

lusc.healthy <- concat.miRNA (lusc.healthy.dir, lusc.healthy.files,rstring=".mirna.quantification.txt")
lusc.tumor <- concat.miRNA (lusc.tumor.dir, lusc.tumor.files, rstring=".mirna.quantification.txt")

lusc.all <- concat.easy.miRNA(lusc.all.dir, lusc.all.files)

#mRNA
lusc.healthy.mrna.raw <- concat.mRNA (mrna.lusc.healthy.dir, mrna.lusc.healthy.files.raw, lusc.healthy.nameconv, "raw_count" )
lusc.tumor.mrna.raw <- concat.mRNA (mrna.lusc.tumor.dir, mrna.lusc.tumor.files.raw, lusc.tumor.nameconv, "raw_count" )
lusc.healthy.mrna.norm <- concat.mRNA (mrna.lusc.healthy.dir, mrna.lusc.healthy.files.norm, lusc.healthy.nameconv, "normalized_count" )
lusc.tumor.mrna.norm <- concat.mRNA (mrna.lusc.tumor.dir, mrna.lusc.tumor.files.norm, lusc.tumor.nameconv, "normalized_count" )

coad.healthy.mrna.raw <- concat.mRNA (mrna.coad.healthy.dir, mrna.coad.healthy.files.raw, coad.healthy.nameconv, "raw_count" )
coad.tumor.mrna.raw <- concat.mRNA (mrna.coad.tumor.dir, mrna.coad.tumor.files.raw, coad.tumor.nameconv, "raw_count" )
coad.healthy.mrna.norm <- concat.mRNA (mrna.coad.healthy.dir, mrna.coad.healthy.files.norm, coad.healthy.nameconv, "normalized_count" )
coad.tumor.mrna.norm <- concat.mRNA (mrna.coad.tumor.dir, mrna.coad.tumor.files.norm, coad.tumor.nameconv, "normalized_count" )


#Figure data
coad.fig <- read.table(file.path(fig.dir, "COAD.ISY.txt.with.miR17-92_patient.txt.txt"), header = T, sep = "\t", quote = "")
lusc.fig <- read.table(file.path(fig.dir, "isy1_17-92.txt"), header = T, sep = "\t", quote = "")



```


```{r}
coad.healthy<- coad.healthy.hg19 
coad.tumor  <- coad.tumor.hg19 
coad.tumor2 <- coad.tumor2.hg19
```

Create metadata information

```{r metadata}
#miRNA

metadata.coad.healthy <- data.frame(ID=colnames(coad.healthy$rpm), status=rep("healthy", ncol(coad.healthy$rpm)), platform=rep("Hiseq", ncol(coad.healthy$rpm)))
metadata.coad.tumor <- data.frame(ID=colnames(coad.tumor$rpm), status=rep("tumor", ncol(coad.tumor$rpm)), platform=rep("Hiseq", ncol(coad.tumor$rpm)))
metadata.coad.tumor2 <- data.frame(ID=colnames(coad.tumor2$rpm), status=rep("tumor", ncol(coad.tumor2$rpm)), platform=rep("GA", ncol(coad.tumor2$rpm)))
metadata.coad <- rbind(metadata.coad.healthy, metadata.coad.tumor)#, metadata.coad.tumor2)

metadata.lusc.healthy <- data.frame(ID=colnames(lusc.healthy$rpm), status=rep("healthy", ncol(lusc.healthy$rpm)), platform=rep("Hiseq", ncol(lusc.healthy$rpm)))
metadata.lusc.tumor <- data.frame(ID=colnames(lusc.tumor$rpm), status=rep("tumor", ncol(lusc.tumor$rpm)), platform=rep("Hiseq", ncol(lusc.tumor$rpm)))

metadata.lusc <- rbind(metadata.lusc.healthy, metadata.lusc.tumor)

#mRNA
metadata.coad.healthy.mrna <- data.frame(ID=colnames(coad.healthy.mrna.norm), status=rep("healthy", ncol(coad.healthy.mrna.norm)))
metadata.coad.tumor.mrna <- data.frame(ID=colnames(coad.tumor.mrna.norm), status=rep("tumor", ncol(coad.tumor.mrna.norm)))

metadata.lusc.healthy.mrna <- data.frame(ID=colnames(lusc.healthy.mrna.norm), status=rep("healthy", ncol(lusc.healthy.mrna.norm)))
metadata.lusc.tumor.mrna <- data.frame(ID=colnames(lusc.tumor.mrna.norm), status=rep("tumor", ncol(lusc.tumor.mrna.norm)))


metadata.lusc.mrna <-  rbind(metadata.lusc.healthy.mrna, metadata.lusc.tumor.mrna )

```

# COAD

## miRNA



```{r}
colnames(coad.fig)[10] <- "isy1"
pca.coad.fig <- pca((coad.fig[,-c(1)]), method = "nipals", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.fig , type="scores", text=F, title="COAD - tumor")
p2 <- plot.pca(pca.coad.fig , type="loadings", text=T, title="COAD - tumor")

#grid.arrange( p1,p2, ncol=2)
```



### hg18 coad miRNA
```{r}
idx = intersect(row.names(coad.healthy$counts), row.names(coad.tumor$counts))
ma = cbind(coad.healthy$counts[idx,], coad.tumor$counts[idx,])
write.table(ma, "~/orch/scratch/gregory_pca/extracted_data/mir-hg18-coad.counts.txt",sep="\t", quote=F)
metadata.coad.healthy <- data.frame(ID=colnames(coad.healthy$counts), status=rep("healthy", ncol(coad.healthy$counts)))
metadata.coad.tumor <- data.frame(ID=colnames(coad.tumor$counts), status=rep("tumor", ncol(coad.tumor$counts)))
metadata.coad = rbind(metadata.coad.healthy, metadata.coad.tumor)
write.table(metadata.coad, "~/orch/scratch/gregory_pca/extracted_data/mir-hg18-coad.metadata.txt",sep="\t", quote=F,row.names=F)
```

```{r pca-coad, fig.width = 16, fig.height = 8}

coad.rpm <- cbind(coad.healthy$rpm, coad.tumor$rpm)#, coad.tumor2$rpm)
coad.counts <- cbind(coad.healthy$counts, coad.tumor$counts)#, coad.tumor2$counts)

pca.coad.rpm <- pca(t(coad.rpm), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.rpm , metadata.coad$status, type="scores", text=F, title="COAD - healthy vs tumor")
p2 <- plot.pca(pca.coad.rpm , type="loadings", text=T, title="COAD - healthy vs tumor")
#p3 <- plot.pca(pca.coad.rpm , metadata.coad$platform, type="scores", text=F, title="COAD - healthy vs tumor")

grid.arrange( p1,p2, ncol=2)
```

```{r writefiles-mir-coad}
write.table(data.frame(mir=rownames(coad.rpm), coad.rpm), file = "files/mir-coad.rpm.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(data.frame(mir=rownames(coad.counts), coad.counts), file = "files/mir-coad.counts.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(metadata.coad, file = "files/mir-coad.metadata.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)

```

__COAD data export__

* [COAD mir counts](files/mir-coad.counts.txt)
* [COAD mir normalized](files/mir-coad.rpm.txt)
* [COAD mir metadata](files/mir-coad.metadata.txt)

### Subset of miRNA                        

```{r extract-mir-coad}
#toMatch <- c("mir-17$", "mir-18a$", "mir-18b$", "mir-19a", "mir-19b", "mir-20a", "mir-20b", "mir-92a" , "mir-92b")
toMatch <- c("mir-17$", "mir-18a$", "mir-18b$", "mir-19a", "mir-19b", "mir-20a", "mir-20b", "mir-92a" , "mir-92b")
matches <- unique (grep(paste(toMatch,collapse="|"), rownames(coad.rpm), value=))

```

#### Normalized counts

```{r pca-coad-sub, fig.width = 16, fig.height = 8}
coad.rpm.mir <- coad.rpm[matches,]

pca.coad.rpm.mir <- pca(t(coad.rpm.mir), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.rpm.mir , metadata.coad$status, type="scores", text=F, title="COAD - scores (healthy vs tumor)")
p2 <- plot.pca(pca.coad.rpm.mir , type="loadings", text=T, title="COAD - loadings")
p3 <- plot.pca(pca.coad.rpm.mir , metadata.coad$platform, type="scores", text=F, title="COAD -scores (platform)")
grid.arrange( p1,p2, ncol=2)
```

#### Normalized counts, averages and ratios

```{r coad-calculating}
coad.mir92 <- colMeans(coad.rpm.mir[c("hsa-mir-92a-1", "hsa-mir-92a-2", "hsa-mir-92b"),])
coad.mir17 <- (coad.rpm.mir[c("hsa-mir-17"),])
coad.mir18 <- colMeans(coad.rpm.mir[c("hsa-mir-18a", "hsa-mir-18b"),])
coad.mir19 <- colMeans(coad.rpm.mir[c("hsa-mir-19a", "hsa-mir-19b-1", "hsa-mir-19b-2"),])
coad.mir20 <- colMeans(coad.rpm.mir[c("hsa-mir-20a", "hsa-mir-20b"),])

coad.avgmir <- cbind(coad.mir17, coad.mir18, coad.mir19, coad.mir20)
colnames(coad.avgmir) <- c("mir17", "mir18", "mir19", "mir20")
coad.ratiomir <- coad.avgmir / coad.mir92
colnames(coad.ratiomir) <- c("mir17/mir92", "mir18/mir92", "mir19/mir92", "mir20/mir92")

coad.mir.conc <- cbind(t(coad.rpm.mir), coad.avgmir, coad.ratiomir) 
```

```{r pca-coad-ratio-avg, fig.width = 16, fig.height = 8}
pca.coad.mir.conc <- pca(coad.mir.conc, method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.mir.conc, metadata.coad$status, type="scores", text=F, title="COAD - scores (healthy vs tumor)")
p2 <- plot.pca(pca.coad.mir.conc , type="loadings", text=T, title="COAD - loadings")
p3 <- plot.pca(pca.coad.mir.conc , metadata.coad$platform, type="scores", text=F, title="COAD -scores (platform)")
grid.arrange( p1,p2, ncol=2)
```


#### Ratios

```{r pca-coad-ratio, fig.width = 16, fig.height = 8}
pca.coad.mir.ratio <- pca(coad.ratiomir , method = "svd", nPcs = 2, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.mir.ratio, metadata.coad$status, type="scores", text=F, title="COAD - scores (healthy vs tumor)")
p2 <- plot.pca(pca.coad.mir.ratio , type="loadings", text=T, title="COAD - loadings")
p3 <- plot.pca(pca.coad.mir.ratio , metadata.coad$platform, type="scores", text=F, title="COAD -scores (platform)")
grid.arrange( p1,p2, ncol=2)
```

## mRNA

### All mRNA

```{r pca-coad-mrna, fig.width = 8, fig.height = 8}
coad.idx <- match(colnames(coad.healthy.mrna.raw),colnames(coad.tumor.mrna.raw))
coad.mrna.norm <- cbind(coad.healthy.mrna.norm, coad.tumor.mrna.norm[,-coad.idx])
coad.mrna.raw <- cbind(coad.healthy.mrna.raw, coad.tumor.mrna.raw[,-coad.idx])

metadata.coad.mrna <-  rbind(metadata.coad.healthy.mrna, metadata.coad.tumor.mrna[-coad.idx,] )

pca.coad.mrna <- pca(t(coad.mrna.norm), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.coad.mrna  , metadata.coad.mrna$status, type="scores", text=F, title="COAD mRNA- healthy vs tumor")


grid.arrange( p1, ncol=1)
```

```{r writefiles-mrna-coad}
write.table(data.frame(mRNA=rownames(coad.mrna.norm), coad.mrna.norm), file = "files/mrna-coad.norm.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(data.frame(mRNA=rownames(coad.mrna.raw), coad.mrna.raw), file = "files/mrna-coad.raw.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(metadata.coad.mrna, file = "files/mrna-coad.metadata.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)

```

__COAD mRNA data export__

* [COAD mrna raw](files/mrna-coad.raw.txt)
* [COAD mrna normalized (rpm)](files/mrna-coad.norm.txt)
* [COAD mrna metadata](files/mrna-coad.metadata.txt)



# LUSC

## miRNA



```{r}
pca.lusc.fig <- pca((lusc.fig[,-c(1)]), method = "nipals", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.fig , type="scores", text=F, title="COAD - healthy vs tumor")
p2 <- plot.pca(pca.lusc.fig , type="loadings", text=T, title="COAD - healthy vs tumor")

#grid.arrange( p1,p2, ncol=2)
```




### All miRNA

```{r pca-lusc, fig.width = 16, fig.height = 8}

lusc.rpm <- cbind(lusc.healthy$rpm, lusc.tumor$rpm)
lusc.counts <- cbind(lusc.healthy$counts, lusc.tumor$counts)

pca.lusc.rpm <- pca(t(lusc.rpm), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.rpm , metadata.lusc$status, type="scores", text=F, title="LUSC - healthy vs tumor")
p2 <- plot.pca(pca.lusc.rpm , type="loadings", text=T, title="LUSC - healthy vs tumor")

grid.arrange( p1,p2, ncol=2)
```

```{r writefiles-mir-lusc}
write.table(data.frame(mir=rownames(lusc.rpm), lusc.rpm), file = "files/mir-lusc.rpm.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(data.frame(mir=rownames(lusc.counts), lusc.counts), file = "files/mir-lusc.counts.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)

write.table(metadata.lusc, file = "files/mir-lusc.metadata.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)

```

### new data: April,28

```{r}
write.table(lusc.all, "~/orch/scratch/gregory_pca/extracted_data/mir-hg18-lusc.counts.txt",sep="\t", quote=F)
```

__LUSC data export__

* [LUSC mir counts](files/mir-lusc.counts.txt)
* [LUSC mir normalized](files/mir-lusc.norm.txt)
* [LUSC mir metadata](files/mir-lusc.metadata.txt)

### Subset of miRNA                        

```{r extract-mir-lusc}
toMatch <- c("mir-17$", "mir-18a$", "mir-18b$", "mir-19a", "mir-19b", "mir-20a", "mir-20b", "mir-92a" , "mir-92b")
matches <- unique (grep(paste(toMatch,collapse="|"), rownames(lusc.rpm), value=))

```

#### Normalized counts

```{r pca-lusc-sub, fig.width = 16, fig.height = 8}
lusc.rpm.mir <- lusc.rpm[matches,]

pca.lusc.rpm.mir <- pca(t(lusc.rpm.mir), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.rpm.mir , metadata.lusc$status, type="scores", text=F, title="LUSC - scores (healthy vs tumor)")
p2 <- plot.pca(pca.lusc.rpm.mir , type="loadings", text=T, title="LUSC - loadings")

grid.arrange( p1,p2, ncol=2)
```

#### Normalized counts, averages and ratios

```{r lusc-calculating}
lusc.mir92 <- colMeans(lusc.rpm.mir[c("hsa-mir-92a-1", "hsa-mir-92a-2", "hsa-mir-92b"),])
lusc.mir17 <- (lusc.rpm.mir[c("hsa-mir-17"),])
lusc.mir18 <- colMeans(lusc.rpm.mir[c("hsa-mir-18a", "hsa-mir-18b"),])
lusc.mir19 <- colMeans(lusc.rpm.mir[c("hsa-mir-19a", "hsa-mir-19b-1", "hsa-mir-19b-2"),])
lusc.mir20 <- colMeans(lusc.rpm.mir[c("hsa-mir-20a", "hsa-mir-20b"),])

lusc.avgmir <- cbind(lusc.mir17, lusc.mir18, lusc.mir19, lusc.mir20)
colnames(lusc.avgmir) <- c("mir17", "mir18", "mir19", "mir20")
lusc.ratiomir <- lusc.avgmir / lusc.mir92
colnames(lusc.ratiomir) <- c("mir17/mir92", "mir18/mir92", "mir19/mir92", "mir20/mir92")

lusc.mir.conc <- cbind(t(lusc.rpm.mir), lusc.avgmir, lusc.ratiomir) 
```

```{r pca-lusc-ratio-avg, fig.width = 16, fig.height = 8}
pca.lusc.mir.conc <- pca(lusc.mir.conc, method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.mir.conc, metadata.lusc$status, type="scores", text=F, title="LUSC - scores (healthy vs tumor)")
p2 <- plot.pca(pca.lusc.mir.conc , type="loadings", text=T, title="LUSC - loadings")

grid.arrange( p1,p2, ncol=2)
```


#### Ratios

```{r pca-lusc-ratio, fig.width = 16, fig.height = 8}
pca.lusc.mir.ratio <- pca(lusc.ratiomir , method = "svd", nPcs = 2, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.mir.ratio, metadata.lusc$status, type="scores", text=F, title="LUSC - scores (healthy vs tumor)")
p2 <- plot.pca(pca.lusc.mir.ratio , type="loadings", text=T, title="LUSC - loadings")

grid.arrange( p1,p2, ncol=2)
```

## mRNA

### All mRNA

```{r pca-lusc-mrna, fig.width = 8, fig.height = 8}
lusc.idx <- match(colnames(lusc.healthy.mrna.raw),colnames(lusc.tumor.mrna.raw))
lusc.mrna.norm <- cbind(lusc.healthy.mrna.norm, lusc.tumor.mrna.norm[,-lusc.idx])
lusc.mrna.raw <- cbind(lusc.healthy.mrna.raw, lusc.tumor.mrna.raw[,-lusc.idx])

metadata.lusc.mrna <-  rbind(metadata.lusc.healthy.mrna, metadata.lusc.tumor.mrna[-lusc.idx,] )

pca.lusc.mrna <- pca(t(lusc.mrna.norm), method = "svd", nPcs = 5, center = T, scale="uv", cv="q2")
p1 <- plot.pca(pca.lusc.mrna  , metadata.lusc.mrna$status, type="scores", text=F, title="LUSC mRNA- healthy vs tumor")


grid.arrange( p1, ncol=1)
```

```{r writefiles-mrna-lusc}
write.table(data.frame(mRNA=rownames(lusc.mrna.norm), lusc.mrna.norm), file = "files/mrna-lusc.norm.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(data.frame(mRNA=rownames(lusc.mrna.raw), lusc.mrna.raw), file = "files/mrna-lusc.raw.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)
write.table(metadata.lusc.mrna, file = "files/mrna-lusc.metadata.txt", append = FALSE, quote = FALSE, sep = "\t", row.names = F)

```

__lusc mRNA data export__

* [LUSC mrna raw](files/mrna-lusc.raw.txt)
* [LUSC mrna normalized](files/mrna-lusc.norm.txt)
* [LUSC mrna metadata](files/mrna-lusc.metadata.txt)


