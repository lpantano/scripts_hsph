---
output:
    knitrBootstrap::bootstrap_document:
        theme: readable
        highlight: zenburn
        theme.chooser: TRUE
        highlight.chooser: TRUE
    html_document:
        toc: true
        highlight: zenburn

---
```{r custom-code-2}
source("~/repos/myRfunctions/transactions.R")
dn <- "rrbs/good_samples"
root_path<-"~/orch/scratch/rrbs/good_samples/work/"
path_files = "~/repos/pipeline/baccarelli-rrbs/good_samples"
knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, 
                    cache=FALSE, highlight=TRUE, autodep=TRUE, warning=FALSE, 
                    error=FALSE,echo=FALSE,
                    eval=TRUE,fig.height=9, fig.width=9,
                    message=FALSE, prompt=TRUE, comment='', fig.cap='', 
                    bootstrap.show.code=FALSE)
options(bitmapType = 'cairo')
```

```{r setup, echo=FALSE,eval=F}
render_2_drop("~/repos/pipelines/baccarelli-rrbs/good_samples/report-9samples.Rmd",dn)
```

```{r packages}
library(tidyr)
library(dplyr)
library(ggplot2)
library(reshape)
library(rmarkdown)
library(knitr)
ggplot <- function(...) ggplot2::ggplot(...) + theme_bw() + scale_fill_brewer(palette = "Set1")
```


# Stats from pilot samples

Number of SNPs that changed CpG methylation sites:

```{r single-sample}
dd = read.table(file.path(root_path, "link", "link_stat.tsv"), header=F, skip=2)
names(dd) = c('sample', '# of snps')
dd

```


Number of SNPs shared among samples.

```{r shared-sample}
dd = read.table(file.path(root_path, "link", "link_shared_stat.tsv"), header=F, skip=2)
names(dd) = c('# of samples', '# of common snps')
dd

```

# example

```{r heatmap}
dd = read.table(file.path(root_path, 'chr4_190641217_190641180.align'))
names(dd) = c(190641180:190641218, 'sample')
dd = dd[order(dd$sample, dd$`190641180`),]
dd$idx = 1:nrow(dd)

metrics = as.data.frame(dd %>% select(sample,snp=`190641180`, cpg=`190641218`)  %>% group_by(sample,snp, cpg) %>% tally())
metrics_by_snp = reshape(metrics, timevar = "cpg", idvar = c("sample", "snp"), direction = "wide")
metrics_by_snp[is.na(metrics_by_snp)] = 0  
metrics_by_snp= metrics_by_snp %>% mutate(pct_methylation = n.Cm/(n.C + n.Cm))
#reshape(metrics_by_snp[,c(1,2,5)], timevar = "snp", idvar = "sample", direction="wide")
ggplot(metrics_by_snp, aes(y=sample, x=snp, fill=pct_methylation)) +
  geom_tile() +
  scale_fill_gradient2(low = "steelblue", mid = "white", high = "orange", midpoint = 0.5 ) +
  ggtitle("ASM site between SNP(chr4:190641180) and  CpG (chr4:190641218)")
```


```{r text}
dd = read.table(file.path(root_path, 'B1850_chr4_example.txt'), sep="", colClasses = "character")
nt = sapply(as.character(dd$V1), function(x){
  sp = unlist(strsplit(x, split=""))
  names(sp) = 190641171:190641227
  if (sp[11] != '-')
    sp
  })
nt=do.call(rbind,Filter(is.vector,nt))

rownames(nt) = paste0("read",1:nrow(nt))
ys = 1:nrow(nt)  
xs=as.numeric(colnames(nt))


.color_pos = function(v, pos){
  pos = as.character(pos)
  names(v) = as.character(names(v))
  nt_col=c("-"='grey40',"a"='red3', "t"='blue2', "c"='orange2', "g"='green2')
  this = rep('grey40', length(v))
  names(this) = names(v)
  this[pos] = nt_col[v[pos]]
  this
}

nt = nt[order(nt[,"190641180"]),]
plot(x=c(xs[1], xs[length(xs)]), y=c(ys[1], ys[length(ys)]), type = 'n', axes=FALSE,
     xlab="position", ylab="")
log=lapply(ys,function(read){
  text(xs, rep(read, dim(nt)[1]), nt[read,], col=.color_pos(nt[read,], c(190641180,190641217)))
  })

```


```{r example}
dd_m = melt(dd, id.vars = c('sample', 'idx'))

ggplot(dd_m, aes(x=variable, y=idx, fill=value)) + geom_tile() +facet_wrap(~sample, scales = 'free_y') +
  scale_fill_manual(values = c("red3","green3","grey80","yellow3","orange3"))  + 
  theme_bw() +
  ylab("read") +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank())

```

 
Report from Bismark

```{r links, results='asis'}
fns = list_files_with_exts("/home/lpantano/repos/pipeline/baccarelli-rrbs/pilot", "html")

for (fn in fns){
   cat(paste0("[",basename(fn),"](",get_report_html(fn),")\n"))
}

```


